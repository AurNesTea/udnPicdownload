name: è‡ªå‹•æ›´æ–°åœ–åº«è³‡æ–™

permissions:
  contents: write

on:
  schedule:
    # æ¯æ—¥ä¸­åˆ12é»žåŸ·è¡Œ (UTC+8 = UTC+0 çš„ 04:00)
    - cron: '0 4 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
        fetch-depth: 0
    
    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: å®‰è£ä¾è³´å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements/requirements.txt
    
    - name: åŸ·è¡Œè³‡æ–™æ›´æ–°
      run: |
        python scripts/update_data_auto.py
    
    - name: æª¢æŸ¥æª”æ¡ˆè®Šæ›´
      id: check-changes
      run: |
        if git diff --quiet data.js; then
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ æ²’æœ‰è³‡æ–™è®Šæ›´"
        else
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ ç™¼ç¾è³‡æ–™è®Šæ›´"
        fi
    
    - name: æäº¤è®Šæ›´
      if: steps.check-changes.outputs.has-changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data.js
        git commit -m "ðŸ¤– è‡ªå‹•æ›´æ–°åœ–åº«è³‡æ–™ - $(date '+%Y-%m-%d %H:%M:%S')"
        git push
    
    - name: å»ºç«‹æ›´æ–°å ±å‘Š
      if: always()
      run: |
        echo "## ðŸ“Š è³‡æ–™æ›´æ–°å ±å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**åŸ·è¡Œæ™‚é–“:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "logs/update_data.log" ]; then
          echo "**æ›´æ–°æ—¥èªŒ:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 logs/update_data.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.check-changes.outputs.has-changes }}" == "true" ]; then
          echo "âœ… **ç‹€æ…‹:** è³‡æ–™å·²æ›´æ–°ä¸¦æäº¤" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **ç‹€æ…‹:** æ²’æœ‰è³‡æ–™è®Šæ›´" >> $GITHUB_STEP_SUMMARY
        fi
